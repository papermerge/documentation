<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Docker Compose &mdash; Papermerge DMS  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Kubernetes" href="kubernetes.html" />
    <link rel="prev" title="Docker" href="docker.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Papermerge DMS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Setup</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="docker.html">Docker</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Docker Compose</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#docker-compose-is-not-for-production">Docker Compose is NOT for Production!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#complete-stack-in-5-minutes">Complete Stack in 5 minutes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backend-only">Backend Only</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-services">External Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#detailed-explanation">Detailed Explanation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#backend-and-frontend">Backend and Frontend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#http-routing">HTTP Routing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#websockets">Websockets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#message-broker-and-workers">Message Broker and Workers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#almost-complete-setup">Almost Complete Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complete-setup">Complete Setup</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="kubernetes.html">Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html">Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrading.html">Upgrading</a></li>
<li class="toctree-l2"><a class="reference internal" href="portainer.html">Portainer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../User%27s%20Manual/index.html">User’s Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Settings/index.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backup_restore.html">Backup/Restore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../REST%20API/index.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Command%20Line%20Utilities/index.html">Command Line Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Contributor%27s%20Manual/index.html">Contributor’s Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Papermerge DMS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Setup</a> &raquo;</li>
      <li>Docker Compose</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Installation/docker-compose.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="docker-compose">
<span id="id1"></span><h1>Docker Compose<a class="headerlink" href="#docker-compose" title="Permalink to this headline"></a></h1>
<p>This section describes how to setup Papermerge and
related services using <a class="reference external" href="https://docs.docker.com/compose/">docker compose</a>.</p>
<p>There are many different setups possible, for example you may want to run only
REST API backend with PostgreSQL database. Another, possibility would be to
start a REST API backend, workers, frontend, websockets server with
PostgreSQL database.</p>
<p>In following sections most common setups are described. Each setup consists of
two files - one yml file (compose file) and one <a class="reference external" href="https://docs.docker.com/compose/env-file/">environment file</a> usually
named <code class="docutils literal notranslate"><span class="pre">.env</span></code>.</p>
<p>Make sure you have both <a class="reference external" href="https://www.docker.com/">docker</a> and <a class="reference external" href="https://docs.docker.com/compose/">docker compose</a> installed.</p>
<p>This guide was tested with docker version 20.10.6 and
docker-compose version 1.29.2.</p>
<section id="docker-compose-is-not-for-production">
<h2>Docker Compose is NOT for Production!<a class="headerlink" href="#docker-compose-is-not-for-production" title="Permalink to this headline"></a></h2>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Docker compose setup is <strong>NOT meant for production</strong>! Docker compose
is <strong>NOT meant to be deployed on remote host</strong> even if that
remote host is within your home network!</p>
</div>
<p>Sure, you can ride on a bicycle from Berlin to Seoul - however bicycles were
not invented for those distances. For 8000 km range it is strongly advised
to take an airplane. In any case, if you decide to use bicycle to cross
Eurasian continent - please don’t insist on getting help!</p>
<p>The same way the airplane is a better choice for long distance
travel - the <a class="reference internal" href="kubernetes.html"><span class="doc">Kubernetes</span></a> is better choice when it comes to
production environments.</p>
<p>The same way bicycle is an excellent option for moving within the city -
docker compose is an excellent choice for quickly trying, playing, testing
Papermerge DMS <strong>on your local computer</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Docker compose is meant to quickly setup Papermerge DMS on your local computer.</p>
</div>
<p>If you are an advanced user considering Papermerge DMS, docker compose
is a great way to instantly start it locally and play bit with it.
For developer standpoint, docker compose is a priceless tool for quick setup
of relatively complex scenarios on development machine - for example to
reproduce a bug for a specific application version.</p>
</section>
<section id="complete-stack-in-5-minutes">
<h2>Complete Stack in 5 minutes<a class="headerlink" href="#complete-stack-in-5-minutes" title="Permalink to this headline"></a></h2>
<p>If you are in hurry and/or you don’t feel like diving into all details, just follow instructions
in this section. It shouldn’t take more than 5 minutes to bootstrap Papermerge DMS.</p>
<p>This setup installs complete Papermerge DMS stack with all required services. It uses <a class="reference external" href="https://doc.traefik.io/traefik/">traefik</a> as edge router.</p>
<p>Save following <a class="reference external" href="https://raw.githubusercontent.com/papermerge/papermerge-core/master/docker/docker-compose.yml">docker-compose.yml</a> file on your local computer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently docker tag <code class="docutils literal notranslate"><span class="pre">latest</span></code> points to latest 2.1.4 version.
See all available docker tags for <a class="reference external" href="https://hub.docker.com/r/papermerge/papermerge/tags">Papermerge on DockerHub</a>.
Similarly, you can check latest <a class="reference external" href="https://hub.docker.com/r/papermerge/papermerge.js/tags">Papermerge_JS</a> tags.</p>
</div>
<p>Next, create <code class="docutils literal notranslate"><span class="pre">.env</span></code> file with following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">APP_IMAGE</span><span class="o">=</span><span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
<span class="n">APP_TAG</span><span class="o">=</span><span class="n">latest</span>
<span class="n">PAPERMERGE_JS_IMAGE</span><span class="o">=</span><span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="o">.</span><span class="n">js</span>
<span class="n">PAPERMERGE_JS_TAG</span><span class="o">=</span><span class="n">latest</span>

<span class="n">TIMEZONE</span><span class="o">=</span><span class="n">Europe</span><span class="o">/</span><span class="n">Berlin</span>

<span class="n">DB_USER</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_NAME</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_HOST</span><span class="o">=</span><span class="n">db</span>
<span class="n">DB_PORT</span><span class="o">=</span><span class="mi">5432</span>

<span class="n">USE_HOSTNAME</span><span class="o">=</span><span class="n">papermerge</span><span class="o">.</span><span class="n">local</span>

<span class="n">REDIS_HOST</span><span class="o">=</span><span class="n">redis</span>
<span class="n">REDIS_PORT</span><span class="o">=</span><span class="mi">6379</span>

<span class="n">SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">abcdxyz</span>

<span class="n">SUPERUSER_USERNAME</span><span class="o">=</span><span class="n">admin</span>
<span class="n">SUPERUSER_EMAIL</span><span class="o">=</span><span class="n">admin</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span>
<span class="n">SUPERUSER_PASSWORD</span><span class="o">=</span><span class="n">admin</span>
</pre></div>
</div>
<p>Add to your <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">127.0.0.1</span>       <span class="n">papermerge</span><span class="o">.</span><span class="n">local</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can add whatever hostname you want e.g. papermerge.myhost
just keep in mind that whatever you add in <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> should
match <code class="docutils literal notranslate"><span class="pre">USE_HOSTNAME</span></code> value from <code class="docutils literal notranslate"><span class="pre">.env</span></code> file</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Variable name to pass hostname is <code class="docutils literal notranslate"><span class="pre">USE_HOSTNAME</span></code>. This variable
used to be named “HOSTNAME” - which caused some problems when
accessing Papermerge from remote host. See this
<a class="reference external" href="https://github.com/papermerge/papermerge-core/issues/17#issuecomment-1145878439">comment in github</a>
for detailed explanation.</p>
</div>
<p>Start Papermerge DMS using following docker compose command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">compose</span> <span class="o">-</span><span class="n">f</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">env</span><span class="o">-</span><span class="n">file</span> <span class="o">.</span><span class="n">env</span> <span class="n">up</span>
</pre></div>
</div>
<p>You can access Papermerge DMS user interface using a web browser like Firefox.
Open your web browser and point it to <a class="reference external" href="http://papermerge.local">http://papermerge.local</a> address:</p>
<figure class="align-default" id="id4">
<img alt="../_images/papermerge-login.png" src="../_images/papermerge-login.png" />
<figcaption>
<p><span class="caption-text">Figure 1. Sign in screen available at <a class="reference external" href="http://papermerge.local">http://papermerge.local</a></span><a class="headerlink" href="#id4" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Sign in using credentials configured with <code class="docutils literal notranslate"><span class="pre">SUPERUSER_USERNAME</span></code> and
<code class="docutils literal notranslate"><span class="pre">SUPERUSER_PASSWORD</span></code> options in <code class="docutils literal notranslate"><span class="pre">.env</span></code> file.</p>
<figure class="align-default" id="id5">
<img alt="../_images/papermerge-example.png" src="../_images/papermerge-example.png" />
<figcaption>
<p><span class="caption-text">Figure 2. Papermerge frontend example</span><a class="headerlink" href="#id5" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="backend-only">
<h2>Backend Only<a class="headerlink" href="#backend-only" title="Permalink to this headline"></a></h2>
<p>This stack installs only Papermerge REST API backend (without fancy user interface). This setup is suitable mostly to play, experiment and explore
Papermerge REST API.</p>
<p>Save <a class="reference external" href="https://raw.githubusercontent.com/papermerge/papermerge-core/master/docker/backend.yml">backend.yml</a>, <a class="reference external" href="https://raw.githubusercontent.com/papermerge/papermerge-core/master/docker/db.yml">db.yml</a> and <a class="reference external" href="https://raw.githubusercontent.com/papermerge/papermerge-core/master/docker/redis.yml">redis.yml</a>
files on your local computer.</p>
<p>Next, create <code class="docutils literal notranslate"><span class="pre">.env</span></code> file with following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">APP_IMAGE</span><span class="o">=</span><span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
<span class="n">APP_TAG</span><span class="o">=</span><span class="n">latest</span>

<span class="n">DB_USER</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_NAME</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_HOST</span><span class="o">=</span><span class="n">db</span>
<span class="n">DB_PORT</span><span class="o">=</span><span class="mi">5432</span>

<span class="n">REDIS_HOST</span><span class="o">=</span><span class="n">redis</span>
<span class="n">REDIS_PORT</span><span class="o">=</span><span class="mi">6379</span>

<span class="n">SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">abcdxyz</span>

<span class="n">SUPERUSER_USERNAME</span><span class="o">=</span><span class="n">admin</span>
<span class="n">SUPERUSER_EMAIL</span><span class="o">=</span><span class="n">admin</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span>
<span class="n">SUPERUSER_PASSWORD</span><span class="o">=</span><span class="n">password</span>
</pre></div>
</div>
<p>Start Papermerge DMS using following docker compose command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">compose</span> <span class="o">-</span><span class="n">f</span> <span class="n">backend</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">f</span> <span class="n">db</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">f</span> <span class="n">redis</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">env</span><span class="o">-</span><span class="n">file</span> <span class="o">.</span><span class="n">env</span> <span class="n">up</span>
</pre></div>
</div>
<p>The above command will start following services:</p>
<ul class="simple">
<li><p>REST API backend</p></li>
<li><p>Worker</p></li>
<li><p>Redis</p></li>
<li><p>PostgreSQL database</p></li>
</ul>
<p>For REST API backend and the worker docker-compose will use
<code class="docutils literal notranslate"><span class="pre">papermerge/papermerge</span></code> docker image.</p>
<p>Now base url for REST API is <code class="docutils literal notranslate"><span class="pre">http://localhost:8000/api/</span></code>.</p>
</section>
<section id="external-services">
<h2>External Services<a class="headerlink" href="#external-services" title="Permalink to this headline"></a></h2>
<p>Papermerge DMS requires three external services:</p>
<ul class="simple">
<li><p>database</p></li>
<li><p>redis</p></li>
</ul>
<p>If you want to play with Papermerge DMS outside of docker compose and you don’t
want bother about database/redis services - you can use
following <a class="reference external" href="https://raw.githubusercontent.com/papermerge/papermerge-core/master/docker/services.yml">services.yml</a> file to quickly setup these external services.</p>
<p>Note <code class="docutils literal notranslate"><span class="pre">networks</span></code> uses <code class="docutils literal notranslate"><span class="pre">driver:</span> <span class="pre">host</span></code>, this will start services in same host
as you local computer.</p>
<p><code class="docutils literal notranslate"><span class="pre">.env</span></code> file content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DB_USER</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_NAME</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
</pre></div>
</div>
<p>Following command will start docker services in same network as host:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">compose</span> <span class="o">-</span><span class="n">f</span> <span class="n">services</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">env</span><span class="o">-</span><span class="n">file</span> <span class="o">.</span><span class="n">env</span> <span class="n">up</span>
</pre></div>
</div>
<p>Docker compose file will start following services in same host as you computer:</p>
<ul class="simple">
<li><p>PostgreSQL</p></li>
<li><p>Redis</p></li>
</ul>
<p>At this point if you start let’s say a development version of Papermerge DMS, you
can use <code class="docutils literal notranslate"><span class="pre">localhost:6379</span></code> to connect to redis or <code class="docutils literal notranslate"><span class="pre">localhost:9300</span></code> use
elasticsearch.</p>
</section>
<section id="detailed-explanation">
<span id="docker-compose-detailed-explanation"></span><h2>Detailed Explanation<a class="headerlink" href="#detailed-explanation" title="Permalink to this headline"></a></h2>
<p>This section dives into detailed explanation of microservice architecture of
Papermerge DMS. We focus here on just enough details so that above mentioned docker
compose setups will make sense for you, and in case something goes wrong you
will be able to understand the problem and troubleshoot it.</p>
<section id="backend-and-frontend">
<h3>Backend and Frontend<a class="headerlink" href="#backend-and-frontend" title="Permalink to this headline"></a></h3>
<p>First important point to understand is that Papermerge DMS has two loosely coupled
parts:</p>
<ul class="simple">
<li><p>backend</p></li>
<li><p>frontend</p></li>
</ul>
<p>Backend is the REST API server, in other words HTTP REST API requests are
processed by backend component. Important characteristic of the backend is
that is does not have graphical user interface.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Backend is entirely written in Python. Here is <a class="reference external" href="https://github.com/papermerge/papermerge-core">backend repository</a>.</p>
</div>
<p>Frontend is the graphical user interface of the application. A less intuitive thing
is that frontend is a separate application. Frontend interacts with backend
via REST API.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Frontend is written in JavaScript, CSS and HTML. Frontend runs
in web browser. Here is <a class="reference external" href="https://github.com/papermerge/papermerge.js">frontend repository</a>.</p>
</div>
<p>Both backend and frontend receive an HTTP request, do something with it, and then
answer that HTTP request with an HTTP response.</p>
<p>Because both, backend and frontend, operate with HTTP requests, we need a way to
separate incoming (for Papermerge DMS) requests: requests designated for backend (REST API calls)
should go to backend service and requests designated for frontend should go to
frontend application. How do we do that? Enter http routing!</p>
</section>
<section id="http-routing">
<h3>HTTP Routing<a class="headerlink" href="#http-routing" title="Permalink to this headline"></a></h3>
<p>We use HTTP PATH in order to decide which requests is designated to which
service. If HTTP request’s PATH contains <code class="docutils literal notranslate"><span class="pre">/api/</span></code> prefix, we route that HTTP
request to backend service, otherwise we route it the frontend.</p>
<p>If, say, there an incoming request of following path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">me</span><span class="o">/</span>
</pre></div>
</div>
<p>The PATH contains <code class="docutils literal notranslate"><span class="pre">/api/</span></code> prefix - thus it is for backend.</p>
<p>If, say, incoming requests looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">assets</span><span class="o">/</span><span class="n">js</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
<p>There is no <code class="docutils literal notranslate"><span class="pre">/api/</span></code> prefix - thus it is for frontend.</p>
<p>This simple logic, where we decide to what microservice http request goes, is
often called as “HTTP Routing”.</p>
<p>We use <a class="reference external" href="https://doc.traefik.io/traefik/">traefik</a> to route http requests between microservices</p>
<figure class="align-default" id="id6">
<img alt="../_images/backend-frontend.svg" src="../_images/backend-frontend.svg" /><figcaption>
<p><span class="caption-text">Figure 3. Routing HTTP requests between frontend and backend
microservices</span><a class="headerlink" href="#id6" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>In illustration above, Papermerge DMS services are isolated from outside access. In
other words, if you try to access backend service directly (via HTTP request)
you won’t be able to. Instead, the only way to access services is via Traefik
which acts as a door that lets all http requests enter “the box”.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Traefik is referred as “the edge router” - from illustration above
you probably understand why</p>
</div>
<p>Now, we arrived to one  extremely important point, where most of the people
get confused: both Frontend and Backend microservices have same base URL!</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Both Frontend and Backend <strong>MUST have same base URL</strong>! In other
words if REST API Backend URL is <a class="reference external" href="http://mydocs:7070/api/">http://mydocs:7070/api/</a>, then Frontend
application must be accessible from <a class="reference external" href="http://mydocs:7070/">http://mydocs:7070/</a> - note that
port number is same.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong>Base URL</strong> is the part of the HTTP address between protocol name (<code class="docutils literal notranslate"><span class="pre">http://</span></code> or <code class="docutils literal notranslate"><span class="pre">https://</span></code>)
and first slash <code class="docutils literal notranslate"><span class="pre">/</span></code>. Note that is also includes port number. Base URLs
where port number differs - are different! E.g. <a class="reference external" href="http://mydocs:7070">http://mydocs:7070</a> != <a class="reference external" href="http://mydocs:7060">http://mydocs:7060</a></p>
</div>
<p>Let me explain this in detail. Let’s say that you run setup with Traefik (in front
of Backend and Frontend microservices) locally on port 6080 and you map in your
<code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 127.0.0.1 to mydms.local. In other words you plan to access
Papermerge DMS via <a class="reference external" href="http://mydms.local:6080">http://mydms.local:6080</a>. When you open your browser and point
it to <a class="reference external" href="http://mydms.local:6080/">http://mydms.local:6080/</a> address, Traefik receives the requests, see
that there is no <code class="docutils literal notranslate"><span class="pre">/api/</span></code> prefix and routes the request to Frontend
microservice. Frontend microservice will respond by returning couple of
javascript, css, and html files; JS, CSS, and HTML files will be loaded in
your browser Frontend application starts - in your browser!</p>
<p>You will see some fancy UI (login screen). Now, (Frontend) application running
in your browser, in order to perform authentication, show your documents,
folders, tags etc etc it needs to access the Backend server.</p>
<p>And here is the crucial moment: how does application running in your browser
know what is the URL for REST API server ?</p>
<figure class="align-default">
<img alt="../_images/thinking-frontend.svg" src="../_images/thinking-frontend.svg" /></figure>
<p>Well, because (Frontend) application is running in your browser, it knows
its own URL (via browsers own <code class="docutils literal notranslate"><span class="pre">window.location</span></code> object). Frontend
application then concludes following: “OK, if I was accessed with
<a class="reference external" href="http://mydms.local:6080/">http://mydms.local:6080/</a>, then REST API server URL which I need to work
with MUST be my own URL + /api/ i.e. <a class="reference external" href="http://mydms.local:6080/api/">http://mydms.local:6080/api/</a>”</p>
<figure class="align-default">
<img alt="../_images/idea.svg" src="../_images/idea.svg" /></figure>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In Papermerge DMS if Frontend application is accessed with base URL
<code class="docutils literal notranslate"><span class="pre">&lt;base_url&gt;</span></code>, then REST API server URL is <code class="docutils literal notranslate"><span class="pre">&lt;base_url&gt;/api/</span></code>.</p>
</div>
<p>Because frontend application does not have any configuration whatsoever,
the only way to know about REST API server URL is by deducing it from
its own URL - it just appends <code class="docutils literal notranslate"><span class="pre">/api/</span></code> prefix!</p>
<p>OK, now that we (hopefully) clarified the theory behind it, let’s adjust
Figure 3 to specific values:</p>
<figure class="align-default" id="id7">
<img alt="../_images/backend-frontend-specific.svg" src="../_images/backend-frontend-specific.svg" /><figcaption>
<p><span class="caption-text">Figure 4</span><a class="headerlink" href="#id7" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Here is docker equivalent compose file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3.7&#39;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">backend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.backend.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/api/`)&quot;</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
  <span class="n">traefik</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;traefik:v2.6&quot;</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;--api.insecure=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker.exposedbydefault=false&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--entrypoints.web.address=:80&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;6080:80&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span>
  <span class="n">frontend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="o">.</span><span class="n">js</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.traefik.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/`)&quot;</span>


<span class="n">Figure</span> <span class="mi">5</span> <span class="o">-</span> <span class="n">content</span> <span class="n">of</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>First couple of remarks regarding traefik configurations. When used with
docker compose traefik uses “labels” to configure routes for services it is
used in of. Note that neither Backend nor Frontend microservice do not map
any ports. Instead ports mapping is done only for traefik - external port
6080 is mapped to traefik’s internal port 80 and traefik’s internal port 80 is
configured as web entry point (line –entrypoints.web.address=:80). In other words
we expose to “outside world” only traefik on (external port) 6080.</p>
<p>Another important remark is that <code class="docutils literal notranslate"><span class="pre">mydms.local</span></code> should be mapped to <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code>;
you do that by adding an entry in your <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat /etc/hosts

127.0.0.1  mydms.local
</pre></div>
</div>
<p>Notice that by default Papermerge DMS create <a class="reference internal" href="../glossary.html#glossary-superuser"><span class="std std-ref">superuser</span></a> with username <code class="docutils literal notranslate"><span class="pre">admin</span></code> and with
password as per environment variable <code class="docutils literal notranslate"><span class="pre">DJANGO_SUPERUSER_PASSWORD</span></code>, which in our
case is 1234.</p>
<p>Finally, if you save text from Figure 5 in file docker-compose.yml, then you can
start all (three) services with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker compose -f docker-compose.yml up
</pre></div>
</div>
<p>Or simply, if you are in same folder as docker-compose.yml file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker compose up
</pre></div>
</div>
<p>Now, open your browser and point it to address <code class="docutils literal notranslate"><span class="pre">http://mydms.local:6080</span></code>.
Sign in using username admin (default) and password 1234 (provided in docker
compose file).
At this point you can sign in, create folders, create users, tags, groups,
upload documents, change preferences.
However, uploaded documents won’t either be OCRed nor indexed. Even
the document status will not change. Why? well, we are not
ready with our setup. Read on.</p>
</section>
<section id="websockets">
<h3>Websockets<a class="headerlink" href="#websockets" title="Permalink to this headline"></a></h3>
<p>What is this websockets thingy anyway and why Papermerge DMS needs it? Websockets
service listens for background OCR events ( like OCR started for document X,
OCR complete for document Y) and sends notifications to your browsers, and it
does it via a technology called <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">WebSockets</a>.</p>
<p>At this stage, even if you add websockes service, you won’t be able to see it
in action - simply because we didn’t add workers yet (thus no OCR is
performed -&gt; thus no OCR events yet). Still, let’s go on and add it now,
because, by this point, it should be trivial - we need just one more PATH
route, which will route all HTTP requests with <code class="docutils literal notranslate"><span class="pre">/ws/</span></code> prefix to websockets
microservice:</p>
<figure class="align-default" id="id8">
<img alt="../_images/backend-frontend-websockets.svg" src="../_images/backend-frontend-websockets.svg" /><figcaption>
<p><span class="caption-text">Figure 6. Routing HTTP requests between frontend, backend
and websockets microservices</span><a class="headerlink" href="#id8" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>And here is updated content for docker-compose.yml file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3.7&#39;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">backend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.backend.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/api/`)&quot;</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
  <span class="n">websockets</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">ws_server</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.ws_server.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/ws/`)&quot;</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
  <span class="n">traefik</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;traefik:v2.6&quot;</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;--api.insecure=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker.exposedbydefault=false&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--entrypoints.web.address=:80&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;6080:80&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span>
  <span class="n">frontend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="o">.</span><span class="n">js</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.traefik.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/`)&quot;</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">websockets</span></code> microservice uses same docker image as the <code class="docutils literal notranslate"><span class="pre">backend</span></code> i.e.
<code class="docutils literal notranslate"><span class="pre">papermerge/papermerge</span></code> and same environment variables as the <code class="docutils literal notranslate"><span class="pre">backend</span></code>.</p>
<p>What differs between <code class="docutils literal notranslate"><span class="pre">websockets</span></code> and <code class="docutils literal notranslate"><span class="pre">backend</span></code> microservices:</p>
<ol class="arabic simple">
<li><p>PathPrefix - for <code class="docutils literal notranslate"><span class="pre">websockets</span></code> microservice path prefix is <code class="docutils literal notranslate"><span class="pre">/ws/</span></code></p></li>
<li><p>docker command - for <code class="docutils literal notranslate"><span class="pre">websockets</span></code> microservice docker command is <code class="docutils literal notranslate"><span class="pre">ws_server</span></code></p></li>
</ol>
<p>Go on and run docker compose command to start all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker compose -f docker-compose.yml up
</pre></div>
</div>
<p>By now, if you run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> command, you will see four microservices running:</p>
<ul class="simple">
<li><p>traefik</p></li>
<li><p>backend</p></li>
<li><p>frontend</p></li>
<li><p>websockets</p></li>
</ul>
<p>As mentioned before, by now you won’t be able to see added value of
<code class="docutils literal notranslate"><span class="pre">websockets</span></code> service. Once we include workers into the picture, I will show
you the effect of <code class="docutils literal notranslate"><span class="pre">websockets</span></code> microservice as well. Workers
is the topic of the next section.</p>
</section>
<section id="message-broker-and-workers">
<h3>Message Broker and Workers<a class="headerlink" href="#message-broker-and-workers" title="Permalink to this headline"></a></h3>
<p>Web applications are build around HTTP request respond cycle. Application
receives an HTTP request, performs some computation like pull data from
database and then responds with HTTP response. Each request/respond cycle
take no more then 500 ms (milliseconds). If request/respond cycle take more
then 500 ms, we tend to say that web application is slow (or specifically
that request which take more then, say 500ms is slow).</p>
<p>The thing is, relatively speaking to request/response cycle - the OCR
processing is infinitely slow - OCR processing of one single A4 page can take
more then a minute! Thus processing of six A4 pages document can easily take
6 minutes - and that’s normal.
In other words, OCR processing does not fit the web application request/response
paradigm.
That’s why, OCR processing is “offloaded” to so called <em>worker</em> or <em>worker processes</em>.
Worker is just another instance of the same application, with two important twists:</p>
<ol class="arabic simple">
<li><p>worker runs in background</p></li>
<li><p>worker receives tasks, and no matter now long it will take - it executes them</p></li>
</ol>
<p>From whom do workers receive tasks and most importantly how ?
In Papermerge DMS workers receive tasks from Backend microservice.
But how?</p>
<p>Workers receive orders (tasks) via so called <em>messaging queue</em>.</p>
<figure class="align-default" id="id9">
<img alt="../_images/messaging-queue.svg" src="../_images/messaging-queue.svg" /><figcaption>
<p><span class="caption-text">Figure 7.</span><a class="headerlink" href="#id9" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>It is more complex then just “workers receive” tasks - workers can
also notify master (via messaging queue) when task is ready, in case
task some workers are busy, there is an option to dispatch tasks
only to the workers which are idle. The point, is that there
is an entity who checks which workers are busy, how many workers are online,
who is willing to take more tasks etc etc. The entity who take care
of all this is called - <em>message broker</em>.</p>
<p>Long story short - Papermerge DMS uses <a class="reference external" href="https://redis.io/">Redis</a> as messaging broker and messaging queue.</p>
<p>Terms “message transport”, “message queue”, “message broker” are loosely
used in many documents to mean different things. It is very easy to get confused.
To avoid any confusion, think that <a class="reference external" href="https://redis.io/">Redis</a> sort of connects all workers with Backend
and serves as communication channel for communication between workers and Backend</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://redis.io/">Redis</a> is used as channel of communication between Backend and workers</p>
</div>
<p>And finally, the most important part for Papermerge DMS. Remember workers are used to OCR
documents. So, if <code class="docutils literal notranslate"><span class="pre">Worker</span> <span class="pre">N</span></code> receives a task to OCR document with given UUID how does
the workers “receives” the document ? And how does worker “sends” the results of its task?
Does worker receive document via messaging queue ?
Does worker sends resulted data via messaging queue ?</p>
<p>No, workers neither receive nor send documents/results via messaging queue.
Instead they read documents/write results from the same shared storage as the Backend.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Workers “receive” documents to be OCRed and “send” their result
via shared storage. In other words, Backend and all workers share
the same document storage.</p>
</div>
<figure class="align-default" id="id10">
<img alt="../_images/shared-storage.svg" src="../_images/shared-storage.svg" /><figcaption>
<p><span class="caption-text">Figure 8. Shared storage between Backend and Workers</span><a class="headerlink" href="#id10" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Finally by this point you understood the theory behind. Here is
the diagram with the services included in docker compose:</p>
<figure class="align-default" id="id11">
<img alt="../_images/backend-frontend-websockets-workers.svg" src="../_images/backend-frontend-websockets-workers.svg" /><figcaption>
<p><span class="caption-text">Figure 9. HTTP Routing, Workers and Redis (as message broker)</span><a class="headerlink" href="#id11" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>And finally, where is docker compose file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3.7&#39;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">backend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.backend.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/api/`)&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">media_root</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">media</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
  <span class="n">worker</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">worker</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">media_root</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">media</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
  <span class="n">ws_server</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">ws_server</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.ws_server.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/ws/`)&quot;</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
  <span class="n">traefik</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;traefik:v2.6&quot;</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;--api.insecure=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker.exposedbydefault=false&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--entrypoints.web.address=:80&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;6080:80&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span>
  <span class="n">frontend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="o">.</span><span class="n">js</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.traefik.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/`)&quot;</span>
  <span class="n">redis</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">redis</span><span class="p">:</span><span class="mi">6</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s1">&#39;6379:6379&#39;</span>

<span class="n">volumes</span><span class="p">:</span>
  <span class="n">media_root</span><span class="p">:</span>
</pre></div>
</div>
<p>You can start docker services with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker compose up
</pre></div>
</div>
<p>However, if you will try to OCR a document, you will get <strong>following error on the worker</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span> <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/venv/lib/python3.8/site-packages/celery/app/trace.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">451</span><span class="p">,</span> <span class="ow">in</span> <span class="n">trace_task</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>     <span class="n">R</span> <span class="o">=</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/venv/lib/python3.8/site-packages/celery/app/trace.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">734</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__protected_call__</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/app/papermerge/core/tasks.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">39</span><span class="p">,</span> <span class="ow">in</span> <span class="n">ocr_document_task</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>     <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">document_id</span><span class="p">)</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/venv/lib/python3.8/site-packages/django/db/models/manager.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">85</span><span class="p">,</span> <span class="ow">in</span> <span class="n">manager_method</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>     <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(),</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/venv/lib/python3.8/site-packages/django/db/models/query.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">496</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span>     <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span>
<span class="n">worker</span><span class="o">-</span><span class="mi">1</span>     <span class="o">|</span> <span class="n">papermerge</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">Document</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span> <span class="n">Document</span> <span class="n">matching</span> <span class="n">query</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>
</pre></div>
</div>
<p>Try to answer - why?
Why worker cannot find document when looking up in database?</p>
<figure class="align-default">
<img alt="../_images/thinking-why.svg" src="../_images/thinking-why.svg" /></figure>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Answer is in following section :P</p>
</div>
</section>
<section id="almost-complete-setup">
<h3>Almost Complete Setup<a class="headerlink" href="#almost-complete-setup" title="Permalink to this headline"></a></h3>
<p>Keyword is <em>database</em>. Do you remember any database configuration in docker
compose ?
I also don’t remember configuring any database. Probably it is because we didn’t configure
any database!</p>
<p>Because there is no database configuration, Papermerge DMS uses SQLite as default
database. SQLite is basically “a database in one single file”. That “single database file”
is created - as is different - for each docker container separately; in other words -
workers and backend use different databases!</p>
<blockquote>
<div><div class="admonition important">
<p class="admonition-title">Important</p>
<p>When no database configurations are present, Papermerge DMS uses
SQLite as default database.</p>
</div>
</div></blockquote>
<p>That’s easy to fix, we add one more service.
Enter PostgreSQL.</p>
<figure class="align-default" id="id12">
<img alt="../_images/almost-all-services.svg" src="../_images/almost-all-services.svg" /><figcaption>
<p><span class="caption-text">Figure 10. Almost all services.</span><a class="headerlink" href="#id12" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Here is our almost final docker-compose.yml file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3.7&#39;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">backend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.backend.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/api/`)&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">media_root</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">media</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__TYPE</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__NAME</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__HOST</span><span class="o">=</span><span class="n">db</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PORT</span><span class="o">=</span><span class="mi">5432</span>
  <span class="n">worker</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">worker</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">media_root</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">media</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__TYPE</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__NAME</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__HOST</span><span class="o">=</span><span class="n">db</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PORT</span><span class="o">=</span><span class="mi">5432</span>
  <span class="n">ws_server</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">ws_server</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.ws_server.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/ws/`)&quot;</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
      <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__TYPE</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__NAME</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__HOST</span><span class="o">=</span><span class="n">db</span>
      <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PORT</span><span class="o">=</span><span class="mi">5432</span>
  <span class="n">traefik</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;traefik:v2.6&quot;</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;--api.insecure=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker.exposedbydefault=false&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--entrypoints.web.address=:80&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;6080:80&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span>
  <span class="n">frontend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="o">.</span><span class="n">js</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.traefik.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/`)&quot;</span>
  <span class="n">redis</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">redis</span><span class="p">:</span><span class="mi">6</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s1">&#39;6379:6379&#39;</span>
  <span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">postgres</span><span class="p">:</span><span class="mf">14.4</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">postgres_data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="n">data</span><span class="o">/</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">POSTGRES_USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_DB</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">volumes</span><span class="p">:</span>
  <span class="n">media_root</span><span class="p">:</span>
  <span class="n">postgres_data</span><span class="p">:</span>
</pre></div>
</div>
<p>As you can see, there is a lots of repetitions: backend, worker and websockets service,
use same environment variables, docker image and mount same volume.</p>
<p>Here is an improved version of docker compose file which re-uses common parts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3.7&#39;</span>
<span class="c1"># Any top-level key starting with x- in a Docker Compose file will be</span>
<span class="c1"># ignored</span>
<span class="n">x</span><span class="o">-</span><span class="n">backend</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">common</span>  <span class="c1"># yaml anchor definition</span>
  <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span>
  <span class="n">volumes</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">media_root</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">media</span>
  <span class="n">environment</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
    <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__TYPE</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__USER</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__NAME</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__HOST</span><span class="o">=</span><span class="n">db</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PORT</span><span class="o">=</span><span class="mi">5432</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">backend</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.backend.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/api/`)&quot;</span>
  <span class="n">ws_server</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">ws_server</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.ws_server.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/ws/`)&quot;</span>
  <span class="n">worker</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">worker</span>
  <span class="n">traefik</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;traefik:v2.6&quot;</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;--api.insecure=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker.exposedbydefault=false&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--entrypoints.web.address=:80&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;6080:80&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span>
  <span class="n">frontend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="o">.</span><span class="n">js</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.traefik.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/`)&quot;</span>
  <span class="n">redis</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">redis</span><span class="p">:</span><span class="mi">6</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s1">&#39;6379:6379&#39;</span>
  <span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">postgres</span><span class="p">:</span><span class="mf">14.4</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">postgres_data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="n">data</span><span class="o">/</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">POSTGRES_USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_DB</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">volumes</span><span class="p">:</span>
  <span class="n">media_root</span><span class="p">:</span>
  <span class="n">postgres_data</span><span class="p">:</span>
</pre></div>
</div>
<p>The above docker compose file uses so called “yaml achors” in order to avoid repetitive
patterns in yaml file.</p>
<p>Now you can start all services with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker compose up
</pre></div>
</div>
<p>If you want to start multiple workers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker compose up --scale worker=3
</pre></div>
</div>
<p>above command will start all services as usual, but instead of one worker instance it will start 3.</p>
</section>
<section id="complete-setup">
<h3>Complete Setup<a class="headerlink" href="#complete-setup" title="Permalink to this headline"></a></h3>
<p>There is one detail left - search engine.</p>
<p>Papermerge DMS supports multiple search engine backends.
By default it uses Xapian search engine - which is a full text search library
integrated into Papermerge DMS backend. This means that you don’t need to
explicitely configure Xapian search engine. What we’ll do however - we’ll
specify the path where Xapian index is stored and we’ll make sure
Workers and Papermerge DMS Backend will use same index path for Xapian.</p>
<figure class="align-default" id="id13">
<img alt="../_images/all-services.svg" src="../_images/all-services.svg" /><figcaption>
<p><span class="caption-text">Figure 11. All microservices. Xapian search engine is part of “Backend” microservices and thus not visible in the illustration.</span><a class="headerlink" href="#id13" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Basically we will just add <code class="docutils literal notranslate"><span class="pre">PAPERMERGE__SEARCH__PATH</span></code> environment variable
and <code class="docutils literal notranslate"><span class="pre">xapian_path</span></code> volume:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3.7&#39;</span>
<span class="c1"># Any top-level key starting with x- in a Docker Compose file will be</span>
<span class="c1"># ignored</span>
<span class="n">x</span><span class="o">-</span><span class="n">backend</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">common</span>  <span class="c1"># yaml anchor definition</span>
  <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="p">:</span><span class="n">latest</span>
  <span class="n">volumes</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">media_root</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">media</span>
    <span class="o">-</span> <span class="n">xapian_index</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">xapian_index</span>  <span class="c1"># &lt;- NEW</span>
  <span class="n">environment</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
    <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__TYPE</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__USER</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__NAME</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__HOST</span><span class="o">=</span><span class="n">db</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PORT</span><span class="o">=</span><span class="mi">5432</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__SEARCH__ENGINE</span><span class="o">=</span><span class="n">xapian</span>  <span class="c1"># this is default value anyway</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__SEARCH__PATH</span><span class="o">=/</span><span class="n">app</span><span class="o">/</span><span class="n">xapian_index</span>  <span class="c1"># &lt;- NEW</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">backend</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.backend.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/api/`)&quot;</span>
  <span class="n">ws_server</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">ws_server</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.ws_server.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/ws/`)&quot;</span>
  <span class="n">worker</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">worker</span>
  <span class="n">traefik</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;traefik:v2.6&quot;</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;--api.insecure=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker.exposedbydefault=false&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--entrypoints.web.address=:80&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;6080:80&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span>
  <span class="n">frontend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="o">.</span><span class="n">js</span><span class="p">:</span><span class="n">latest</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.traefik.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/`)&quot;</span>
  <span class="n">redis</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">redis</span><span class="p">:</span><span class="mi">6</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s1">&#39;6379:6379&#39;</span>
  <span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">postgres</span><span class="p">:</span><span class="mf">14.4</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">postgres_data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="n">data</span><span class="o">/</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">POSTGRES_USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_DB</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">volumes</span><span class="p">:</span>
  <span class="n">media_root</span><span class="p">:</span>
  <span class="n">postgres_data</span><span class="p">:</span>
  <span class="n">xapian_index</span><span class="p">:</span>  <span class="c1"># &lt;- NEW</span>
</pre></div>
</div>
<p>Finally, for sake of completeness, here is setup which uses Elasticsearch
instead of Xapian:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3.7&#39;</span>
<span class="c1"># Any top-level key starting with x- in a Docker Compose file will be</span>
<span class="c1"># ignored</span>
<span class="n">x</span><span class="o">-</span><span class="n">backend</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">common</span>  <span class="c1"># yaml anchor definition</span>
  <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="p">:</span><span class="n">latest</span>
  <span class="n">volumes</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">media_root</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">media</span>
  <span class="n">environment</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__MAIN__SECRET_KEY</span><span class="o">=</span><span class="mi">12345</span><span class="n">SKK</span>
    <span class="o">-</span> <span class="n">DJANGO_SUPERUSER_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__HOST</span><span class="o">=</span><span class="n">redis</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__REDIS__PORT</span><span class="o">=</span><span class="mi">6379</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__TYPE</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__USER</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__NAME</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__HOST</span><span class="o">=</span><span class="n">db</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__DATABASE__PORT</span><span class="o">=</span><span class="mi">5432</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__SEARCH__ENGINE</span><span class="o">=</span><span class="n">elastic7</span>
    <span class="o">-</span> <span class="n">PAPERMERGE__SEARCH__URL</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">es</span><span class="p">:</span><span class="mi">9200</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">backend</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.backend.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/api/`)&quot;</span>
  <span class="n">ws_server</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">ws_server</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.ws_server.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/ws/`)&quot;</span>
  <span class="n">worker</span><span class="p">:</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">common</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">worker</span>
  <span class="n">traefik</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;traefik:v2.6&quot;</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;--api.insecure=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--providers.docker.exposedbydefault=false&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;--entrypoints.web.address=:80&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;6080:80&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span>
  <span class="n">frontend</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">papermerge</span><span class="o">/</span><span class="n">papermerge</span><span class="o">.</span><span class="n">js</span>
    <span class="n">labels</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.enable=true&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;traefik.http.routers.traefik.rule=Host(`mydms.local`) &amp;&amp; PathPrefix(`/`)&quot;</span>
  <span class="n">redis</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">redis</span><span class="p">:</span><span class="mi">6</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s1">&#39;6379:6379&#39;</span>
  <span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">postgres</span><span class="p">:</span><span class="mf">14.4</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">postgres_data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="n">data</span><span class="o">/</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">POSTGRES_USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_DB</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
  <span class="n">es</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">docker</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="p">:</span><span class="mf">7.16.2</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">discovery</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">single</span><span class="o">-</span><span class="n">node</span>
      <span class="o">-</span> <span class="s2">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="mi">9200</span><span class="p">:</span><span class="mi">9200</span>
      <span class="o">-</span> <span class="mi">9300</span><span class="p">:</span><span class="mi">9300</span>
<span class="n">volumes</span><span class="p">:</span>
  <span class="n">media_root</span><span class="p">:</span>
  <span class="n">postgres_data</span><span class="p">:</span>
</pre></div>
</div>
<figure class="align-default" id="id14">
<img alt="../_images/all-services-with-es.svg" src="../_images/all-services-with-es.svg" /><figcaption>
<p><span class="caption-text">Figure 12. All microservices. Elasticsearch (version 7) is used as search engine backend.</span><a class="headerlink" href="#id14" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline"></a></h2>
<p>To be added…</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="docker.html" class="btn btn-neutral float-left" title="Docker" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="kubernetes.html" class="btn btn-neutral float-right" title="Kubernetes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2023, Papermerge DMS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../2.0.0/index.html">2.0.0</a></dd>
      <dd><a href="../../2.0.1/index.html">2.0.1</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="docker-compose.html">master</a></dd>
      <dd><a href="../../2.0.x/index.html">2.0.x</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>